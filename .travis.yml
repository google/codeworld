# https://docs.haskellstack.org/en/stable/travis_ci/

sudo: true
dist: bionic
language: generic
cache:
  directories:
  - $HOME/.local/bin
  - $HOME/.stack
  - $TRAVIS_BUILD_DIR/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-account/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-api/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-auth/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-base/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-compiler/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-error-sanitizer/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-game-api/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-game-server/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-prediction/.stack-work
  - $TRAVIS_BUILD_DIR/codeworld-server/.stack-work
  - $HOME/.ghcjs
  - $HOME/.ghc
  - $HOME/.cabal
  - $TRAVIS_BUILD_DIR/ghcjs/.cabal-sandbox
  - $TRAVIS_BUILD_DIR/ghcjs/data
  - $TRAVIS_BUILD_DIR/ghcjs/dist
  - $TRAVIS_BUILD_DIR/ghcjs/dist-newstyle
  - $TRAVIS_BUILD_DIR/ghcjs/ghcjs-boot
  - $TRAVIS_BUILD_DIR/ghcjs/lib
  - $TRAVIS_BUILD_DIR/ghcjs/lib/boot/data
  - $TRAVIS_BUILD_DIR/ghcjs/lib/boot/pkg
  - $TRAVIS_BUILD_DIR/ghcjs/utils
  - $TRAVIS_BUILD_DIR/ghcjs/vendor

addons:
  apt:
    update: true
    packages:
      - libgmp-dev
      - haskell-stack

jobs:
  include:
    - stage: Install Stack
      script:
        - export DIR=~/.local/bin
        - if [ ! -d "$DIR" ]; then mkdir -p ~/.local/bin; fi
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack install --resolver lts-14.11 happy-1.19.9 alex-3.2.4
    - stage: Build dependencies
      name: "Build dependencies"
      script:
        # - stack clean --full  # if unreliability persists
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack build --dependencies-only
    - stage: Build
      name: "root"
      env: PACKAGE="."
      script: &build
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack build $PACKAGE
    - stage: Build
      name: "Account"
      env: PACKAGE="codeworld-account"
      script: *build
    - stage: Build
      name: "API"
      env: PACKAGE="codeworld-api"
      script: *build
    - stage: Build
      name: "Auth"
      env: PACKAGE="codeworld-auth"
      script: *build
    - stage: Build
      name: "Base (with ghcjs-base-stub)"
      env: PACKAGE="codeworld-base"
      script: *build
    - stage: Build
      name: "Compiler"
      env: PACKAGE="codeworld-compiler"
      script: *build
    - stage: Build
      name: "Error Sanitizer"
      env: PACKAGE="codeworld-error-sanitizer"
      script: *build
    - stage: Build
      name: "Game API"
      env: PACKAGE="codeworld-game-api"
      script: *build
    - stage: Build
      name: "Game Server"
      env: PACKAGE="codeworld-game-server"
      script: *build
    - stage: Build
      name: "Prediction"
      env: PACKAGE="codeworld-prediction"
      script: *build
    - stage: Build
      name: "Server"
      env: PACKAGE="codeworld-server"
      script: *build
    # - stage: Test
    #   name: "root"
    #  env: PACKAGE="*"
    #   script: *test
    - stage: Test
      name: "Account"
      env: PACKAGE="codeworld-account"
      script: &test
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack test $PACKAGE
    - stage: Test
      name: "API"
      env: PACKAGE="codeworld-api"
      script: *test
    - stage: Test
      name: "Auth"
      env: PACKAGE="codeworld-auth"
      script: *test
    - stage: Test
      name: "Base"
      env: PACKAGE="codeworld-base"
      script: *test
    # - stage: Test
    #   name: "Compiler"
    #   env: PACKAGE="codeworld-compiler"
    #   script: *test
    - stage: Test
      name: "Error Sanitizer"
      env: PACKAGE="codeworld-error-sanitizer"
      script: *test
    - stage: Test
      name: "Game API"
      env: PACKAGE="codeworld-game-api"
      script: *test
    - stage: Test
      name: "Game Server"
      env: PACKAGE="codeworld-game-server"
      script: *test
    - stage: Test
      name: "Prediction"
      env: PACKAGE="codeworld-prediction"
      script: *test
    - stage: Test
      name: "Server"
      env: PACKAGE="codeworld-server"
      script: *test
    - stage: Build GHCJS dependencies
      name: "Build GHCJS dependencies"
      script:
        - sudo add-apt-repository --yes ppa:hvr/ghc
        - sudo apt-get update
        - sudo apt-get install --yes build-essential cabal-install-2.4 ghc-8.6.5
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack install --resolver lts-14.11 happy-1.19.9 alex-3.2.4
        - nvm install 10
        - export PATH=$PWD/.cabal-sandbox/bin:$HOME/.cabal/bin:/opt/ghc/8.6.5/bin:/opt/cabal/2.4/bin:$PATH
        - export
        - cd ghcjs
        - git submodule update --init --recursive
        - ./utils/makePackages.sh
        - cabal new-update
        - cabal new-configure
        - cabal new-build -j --only-dependencies --disable-optimization
    - stage: Build GHCJS
      name: "Build GHCJS"
      script:
        - sudo add-apt-repository --yes ppa:hvr/ghc
        - sudo apt-get update
        - sudo apt-get install --yes build-essential cabal-install-2.4 ghc-8.6.5
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack install --resolver lts-14.11 happy-1.19.9 alex-3.2.4
        - nvm install 10
        - export PATH=$PWD/.cabal-sandbox/bin:$HOME/.cabal/bin:/opt/ghc/8.6.5/bin:/opt/cabal/2.4/bin:$PATH
        - export
        - cd ghcjs
        - git submodule update --init --recursive
        - ./utils/makePackages.sh
        - cabal new-build -j
    - stage: install GHCJS
      name: "install GHCJS"
      script:
        - sudo add-apt-repository --yes ppa:hvr/ghc
        - sudo apt-get update
        - sudo apt-get install --yes build-essential cabal-install-2.4 ghc-8.6.5
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack install --resolver lts-14.11 happy-1.19.9 alex-3.2.4
        - nvm install 10
        - export PATH=$PWD/.cabal-sandbox/bin:$HOME/.cabal/bin:/opt/ghc/8.6.5/bin:/opt/cabal/2.4/bin:$PATH
        - export
        - cd ghcjs
        - git submodule update --init --recursive
        - ./utils/makePackages.sh
        - cabal new-install --only-dependencies --lib
        - cabal new-install -v --lib
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-pkg
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/haddock-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/hsc2hs-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-boot
    - stage: GHCJS Boot
      name: "GHCJS Boot"
      script:
        - sudo add-apt-repository --yes ppa:hvr/ghc
        - sudo apt-get update
        - sudo apt-get install --yes build-essential cabal-install-2.4 ghc-8.6.5
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack install --resolver lts-14.11 happy-1.19.9 alex-3.2.4
        - nvm install 10
        - export PATH=$PWD/.cabal-sandbox/bin:$HOME/.cabal/bin:/opt/ghc/8.6.5/bin:/opt/cabal/2.4/bin:$PATH
        - export
        - git submodule update --init --recursive
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-pkg
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/haddock-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/hsc2hs-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-boot
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-run
        - cd ghcjs
        - git submodule update --init --recursive
        - ./utils/makePackages.sh
        - ghcjs --version
        - ghcjs-boot -j -s $TRAVIS_BUILD_DIR/ghcjs/lib/boot --no-haddock --no-prof
        - cabal --ghcjs --version
    - stage: Build_with_GHCJS
      name: "API (with ghcjs)"
      env: PACKAGE="codeworld-api"
      script: &build_with_ghcjs
        - sudo add-apt-repository --yes ppa:hvr/ghc
        - sudo apt-get update
        - sudo apt-get install --yes build-essential cabal-install-2.4 ghc-8.6.5
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack install --resolver lts-14.11 happy-1.19.9 alex-3.2.4
        - nvm install 10
        - export PATH=$PWD/.cabal-sandbox/bin:$HOME/.cabal/bin:/opt/ghc/8.6.5/bin:/opt/cabal/2.4/bin:$PATH
        - export
        - git submodule update --init --recursive
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-pkg
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/haddock-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/hsc2hs-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-boot
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-run
        - cabal --ghcjs new-configure $PACKAGE
        - cabal --ghcjs new-build -j $PACKAGE
    - stage: Build_with_GHCJS
      name: "Base (with ghcjs)"
      env: PACKAGE="codeworld-base"
      script: *build_with_ghcjs
    # succeeds, but can't be build yet without GHCJS and therefore omitted from cabal.project` file
    # - stage: Build_with_GHCJS`
    #   name: "Funblocks-client (with ghcjs)"
    #   env: PACKAGE="funblocks-client"
    #   script: *build_with_ghcjs
    - stage: Test_with_GHCJS
      name: "API (with ghcjs)"
      env: PACKAGE="codeworld-api"
      script: &test_with_ghcjs
        - sudo add-apt-repository --yes ppa:hvr/ghc
        - sudo apt-get update
        - sudo apt-get install --yes build-essential cabal-install-2.4 ghc-8.6.5
        - export PATH=$HOME/.local/bin:$PATH
        - stack upgrade
        - hash -r
        - stack install --resolver lts-14.11 happy-1.19.9 alex-3.2.4
        - nvm install 10
        - export PATH=$PWD/.cabal-sandbox/bin:$HOME/.cabal/bin:/opt/ghc/8.6.5/bin:/opt/cabal/2.4/bin:$PATH
        - export
        - git submodule update --init --recursive
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-pkg
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/haddock-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/hsc2hs-ghcjs
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-boot
        - sudo ln -fs $TRAVIS_BUILD_DIR/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/ghcjs-run
        - cabal --ghcjs new-configure $PACKAGE
        - cabal --ghcjs new-test $PACKAGE
    - stage: Test_with_GHCJS
      name: "Prediction (with ghcjs)"
      env: PACKAGE="codeworld-prediction"
      script: *test_with_ghcjs
    # succeeds, but can't be build yet without GHCJS and therefore omitted from cabal.project` file
    # - stage: Test_with_GHCJS
    #   name: "Funblocks-client (with ghcjs)"
    #   env: PACKAGE="funblocks-client"
    #   script: *test_with_ghcjs
